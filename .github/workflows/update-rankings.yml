name: Update Tennis Rankings

on:
  schedule:
    # Executa toda segunda-feira às 6h (horário UTC - Brasília é UTC-3)
    # Para 6h Brasília = 9h UTC
    - cron: '0 9 * * 1'
  
  # Permite execução manual
  workflow_dispatch:

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test basic imports
      run: |
        python -c "import requests; import feedparser; import json; print('✅ Imports OK')"
    
    - name: Update rankings
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python -c "
        import sys
        import os
        
        # Adiciona diretório atual ao path
        sys.path.insert(0, '.')
        
        try:
            from tennis_bot import update_rankings, send_telegram_message
            print('✅ Import das funções OK')
            
            # Tenta atualizar rankings
            players = update_rankings()
            print(f'✅ Rankings processados: {len(players)} jogadores')
            
            if len(players) > 100:  # Limiar mais baixo para teste
                message = f'📊 <b>Rankings Atualizados!</b>\n\n✅ {len(players)} jogadores atualizados\n🔄 Top 250 ATP + Top 250 WTA\n📅 Próxima atualização: segunda-feira'
                try:
                    send_telegram_message(message)
                    print('✅ Mensagem enviada com sucesso')
                except Exception as e:
                    print(f'⚠️ Erro ao enviar mensagem: {e}')
            else:
                message = f'⚠️ <b>Atualização Parcial</b>\n\n📊 {len(players)} jogadores encontrados\n📋 Usando rankings de backup\n🔄 Tentativa na próxima segunda-feira'
                try:
                    send_telegram_message(message)
                    print('⚠️ Poucos jogadores encontrados')
                except Exception as e:
                    print(f'⚠️ Erro ao enviar mensagem: {e}')
                    
        except ImportError as e:
            print(f'❌ Erro de import: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'❌ Erro geral: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
    
    - name: Commit updated rankings
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Adiciona arquivo de rankings se existir
        if [ -f "current_rankings.json" ]; then
          git add current_rankings.json
          git commit -m "🤖 Auto-update tennis rankings" || echo "No changes to commit"
          git push || echo "No changes to push"
        else
          echo "❌ Arquivo current_rankings.json não foi gerado"
        fi
