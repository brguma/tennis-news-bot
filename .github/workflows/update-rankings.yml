name: Update Tennis Rankings

on:
  schedule:
    # Executa toda segunda-feira Ã s 6h (horÃ¡rio UTC - BrasÃ­lia Ã© UTC-3)
    # Para 6h BrasÃ­lia = 9h UTC
    - cron: '0 9 * * 1'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test basic imports
      run: |
        python -c "import requests; import feedparser; import json; print('âœ… Imports OK')"
    
    - name: Update rankings
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python -c "
        import sys
        import os
        
        # Adiciona diretÃ³rio atual ao path
        sys.path.insert(0, '.')
        
        try:
            from tennis_bot import update_rankings, send_telegram_message
            print('âœ… Import das funÃ§Ãµes OK')
            
            # Tenta atualizar rankings
            players = update_rankings()
            print(f'âœ… Rankings processados: {len(players)} jogadores')
            
            if len(players) > 100:  # Limiar mais baixo para teste
                message = f'ğŸ“Š <b>Rankings Atualizados!</b>\n\nâœ… {len(players)} jogadores atualizados\nğŸ”„ Top 250 ATP + Top 250 WTA\nğŸ“… PrÃ³xima atualizaÃ§Ã£o: segunda-feira'
                try:
                    send_telegram_message(message)
                    print('âœ… Mensagem enviada com sucesso')
                except Exception as e:
                    print(f'âš ï¸ Erro ao enviar mensagem: {e}')
            else:
                message = f'âš ï¸ <b>AtualizaÃ§Ã£o Parcial</b>\n\nğŸ“Š {len(players)} jogadores encontrados\nğŸ“‹ Usando rankings de backup\nğŸ”„ Tentativa na prÃ³xima segunda-feira'
                try:
                    send_telegram_message(message)
                    print('âš ï¸ Poucos jogadores encontrados')
                except Exception as e:
                    print(f'âš ï¸ Erro ao enviar mensagem: {e}')
                    
        except ImportError as e:
            print(f'âŒ Erro de import: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âŒ Erro geral: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
    
    - name: Commit updated rankings
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Adiciona arquivo de rankings se existir
        if [ -f "current_rankings.json" ]; then
          git add current_rankings.json
          git commit -m "ğŸ¤– Auto-update tennis rankings" || echo "No changes to commit"
          git push || echo "No changes to push"
        else
          echo "âŒ Arquivo current_rankings.json nÃ£o foi gerado"
        fi
