name: Update Tennis Rankings

on:
  schedule:
    # Executa toda segunda-feira Ã s 6h (horÃ¡rio UTC - BrasÃ­lia Ã© UTC-3)
    # Para 6h BrasÃ­lia = 9h UTC
    - cron: '0 9 * * 1'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml
    
    - name: Update rankings
      run: |
        python -c "
        from tennis_bot import update_rankings, send_telegram_message
        import os
        
        # Configura tokens para notificaÃ§Ã£o
        os.environ['TELEGRAM_BOT_TOKEN'] = '${{ secrets.TELEGRAM_BOT_TOKEN }}'
        os.environ['TELEGRAM_CHAT_ID'] = '${{ secrets.TELEGRAM_CHAT_ID }}'
        
        # Atualiza rankings
        players = update_rankings()
        
        if len(players) > 400:  # Se conseguiu buscar pelo menos 400 jogadores
            message = f'ğŸ“Š <b>Rankings Atualizados!</b>\n\nâœ… {len(players)} jogadores atualizados\nğŸ”„ Top 250 ATP + Top 250 WTA\nğŸ“… PrÃ³xima atualizaÃ§Ã£o: segunda-feira'
            send_telegram_message(message)
            print(f'âœ… Rankings atualizados com sucesso: {len(players)} jogadores')
        else:
            message = f'âš ï¸ <b>Falha na AtualizaÃ§Ã£o</b>\n\nâŒ Erro ao buscar rankings\nğŸ“‹ Usando rankings anteriores\nğŸ”„ Tentativa na prÃ³xima segunda-feira'
            send_telegram_message(message)
            print('âŒ Falha na atualizaÃ§Ã£o dos rankings')
        "
    
    - name: Commit updated rankings
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Adiciona arquivo de rankings se existir
        if [ -f "current_rankings.json" ]; then
          git add current_rankings.json
          git commit -m "ğŸ¤– Auto-update tennis rankings" || echo "No changes to commit"
          git push || echo "No changes to push"
        fi
