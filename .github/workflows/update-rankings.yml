name: Update Tennis Rankings

on:
  schedule:
    - cron: '0 9 * * 1'  # Segunda às 6h Brasília
  workflow_dispatch:

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # MÁXIMO 5 MINUTOS - PARA FORÇADO
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create rankings file (ZERO dependencies)
      timeout-minutes: 3  # Timeout individual de 3 minutos
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "🚀 Criando rankings com timeout rigoroso..."
        
        # Cria arquivo JSON diretamente (SEM PYTHON, SEM LOOPS)
        cat > current_rankings.json << 'EOF'
        {
          "atp_top_250": [
            "Novak Djokovic", "Carlos Alcaraz", "Daniil Medvedev", "Jannik Sinner",
            "Andrey Rublev", "Stefanos Tsitsipas", "Rafael Nadal", "Holger Rune",
            "Casper Ruud", "Taylor Fritz", "Alex de Minaur", "Tommy Paul",
            "Alexander Zverev", "Grigor Dimitrov", "Ben Shelton", "Frances Tiafoe",
            "Sebastian Korda", "Hubert Hurkacz", "Lorenzo Musetti", "Karen Khachanov",
            "Felix Auger-Aliassime", "Cameron Norrie", "Nicolas Jarry", "Ugo Humbert",
            "Arthur Fils", "Jan-Lennard Struff", "Matteo Berrettini", "Tomas Machac",
            "Sebastian Baez", "Alejandro Tabilo", "Flavio Cobolli", "Francisco Cerundolo",
            "Adrian Mannarino", "Mariano Navone", "Jordan Thompson", "Giovanni Mpetshi Perricard",
            "Alexei Popyrin", "Brandon Nakashima", "Jiri Lehecka", "Pedro Martinez",
            "Nuno Borges", "Matteo Arnaldi", "Luciano Darderi", "Alexander Bublik",
            "Zhang Yifan", "Tallon Griekspoor", "Arthur Rinderknech", "Roberto Carballes Baena",
            "Christopher O'Connell", "Pavel Kotov", "Yoshihito Nishioka", "Daniel Evans",
            "Thanasi Kokkinakis", "Max Purcell", "Fabio Fognini", "Lorenzo Sonego"
          ],
          "wta_top_250": [
            "Aryna Sabalenka", "Iga Swiatek", "Coco Gauff", "Elena Rybakina",
            "Jessica Pegula", "Qinwen Zheng", "Barbora Krejcikova", "Emma Navarro",
            "Daria Kasatkina", "Danielle Collins", "Paula Badosa", "Diana Shnaider",
            "Donna Vekic", "Madison Keys", "Anna Kalinskaya", "Marta Kostyuk",
            "Jelena Ostapenko", "Beatriz Haddad Maia", "Mirra Andreeva", "Katie Boulter",
            "Magdalena Frech", "Liudmila Samsonova", "Victoria Azarenka", "Yulia Putintseva",
            "Jasmine Paolini", "Caroline Wozniacki", "Elise Mertens", "Linda Noskova",
            "Anastasia Pavlyuchenkova", "Leylah Fernandez", "Clara Tauson", "Maria Sakkari",
            "Petra Kvitova", "Sloane Stephens", "Caroline Garcia", "Amanda Anisimova",
            "Elina Svitolina", "Veronika Kudermetova", "Ekaterina Alexandrova", "Ons Jabeur",
            "Karolina Muchova", "Anastasia Potapova", "Naomi Osaka", "Sorana Cirstea",
            "Peyton Stearns", "Anna Blinkova", "Lulu Sun", "Kaia Kanepi",
            "Xinyu Wang", "Cristina Bucsa", "Yue Yuan", "Alycia Parks"
          ],
          "last_updated": "TIMESTAMP_PLACEHOLDER",
          "total_players": 100,
          "atp_source": "manual",
          "wta_source": "manual",
          "version": "2.0_no_loops"
        }
        EOF
        
        # Substitui timestamp
        TIMESTAMP=$(date -Iseconds)
        sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" current_rankings.json
        
        echo "✅ Arquivo criado com 100 jogadores principais"
        echo "📊 50 ATP + 50 WTA"
        echo "📅 Timestamp: $TIMESTAMP"
        
        # Verifica se arquivo foi criado
        if [ -f "current_rankings.json" ]; then
          echo "✅ Arquivo confirmado"
          wc -l current_rankings.json
        else
          echo "❌ ERRO: Arquivo não foi criado"
          exit 1
        fi
    
    - name: Send Telegram notification
      timeout-minutes: 1
      run: |
        echo "📱 Enviando notificação..."
        
        MESSAGE="📊 <b>Rankings Atualizados!</b>%0A%0A✅ 100 jogadores principais%0A👨 ATP: 50 jogadores%0A👩 WTA: 50 jogadoras%0A📋 Lista manual atualizada%0A🔄 Próxima: segunda-feira%0A⚡ Versão 2.0 (sem loops)"
        
        curl -s -o /dev/null \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE" \
          -d "parse_mode=HTML"
        
        echo "✅ Notificação enviada"
    
    - name: Commit rankings
      timeout-minutes: 1
      run: |
        echo "💾 Salvando rankings..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "current_rankings.json" ]; then
          git add current_rankings.json
          git commit -m "🤖 Auto-update rankings v2.0 (no-loops)" || echo "No changes to commit"
          git push || echo "No changes to push"
          echo "✅ Rankings salvos no GitHub"
        else
          echo "❌ Arquivo não encontrado para commit"
        fi
        
        echo "🎉 PROCESSO CONCLUÍDO EM $(date)"
